<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiva Support - Neshama</title>
    <meta name="description" content="Help coordinate meals and support for a family during their shiva period.">
    <meta name="theme-color" content="#3E2723">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Neshama">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #B2BEB5;
            --sage-dark: #8a9a8d;
            --terracotta: #D2691E;
            --warm-beige: #F5F5DC;
            --cream: #FAF9F6;
            --dark-brown: #3E2723;
            --light-taupe: #D4C5B9;
            --gold: #C9A96E;
            --soft-shadow: rgba(62, 39, 35, 0.08);
            --warm-glow: rgba(210, 105, 30, 0.15);
            --green-light: #f1f8e9;
            --green-mid: #a5d6a7;
            --green-text: #558b2f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        ::selection {
            background: rgba(210, 105, 30, 0.2);
            color: var(--dark-brown);
        }

        body {
            font-family: 'Source Serif 4', serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--warm-beige) 100%);
            color: var(--dark-brown);
            line-height: 1.7;
            min-height: 100vh;
        }

        a:focus-visible, button:focus-visible, input:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--terracotta);
            outline-offset: 3px;
            border-radius: 4px;
        }

        input:focus-visible, textarea:focus-visible {
            outline-offset: 0;
        }

        /* ── Navigation ─────────────────────────────────── */

        .nav {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--light-taupe);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--dark-brown);
            text-decoration: none;
            letter-spacing: 0.02em;
        }

        .nav-brand:hover { opacity: 0.7; }

        .nav-links { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .nav-links a { color: var(--dark-brown); text-decoration: none; font-size: 1rem; transition: color 0.2s; }
        .nav-links a:hover { color: var(--terracotta); }

        /* ── Page Container ──────────────────────────────── */

        .page-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
        }

        /* ── Loading & Error States ──────────────────────── */

        .page-loading {
            text-align: center;
            padding: 6rem 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-taupe);
            border-top-color: var(--terracotta);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .page-loading p { font-size: 1.2rem; color: var(--sage-dark); font-style: italic; }

        .error-state {
            text-align: center;
            padding: 6rem 2rem;
        }

        .error-state h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        .error-state p { font-size: 1.1rem; color: var(--sage-dark); margin-bottom: 2rem; }

        .error-state a {
            display: inline-block;
            background: var(--terracotta);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 2rem;
            text-decoration: none;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .error-state a:hover { background: #c45a1a; transform: translateY(-2px); }

        /* ── Hero Section ────────────────────────────────── */

        .shiva-hero {
            text-align: center;
            padding: 3rem 0 2rem;
        }

        .shiva-hero h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 400;
            margin-bottom: 0.25rem;
        }

        .shiva-hero .organized-by {
            font-size: 1.05rem;
            color: var(--sage-dark);
            margin-bottom: 0.35rem;
        }

        .shiva-hero .dates {
            font-size: 1.1rem;
            color: var(--sage-dark);
            margin-bottom: 0.5rem;
        }

        .shiva-hero .memorial-link {
            display: inline-block;
            color: var(--terracotta);
            text-decoration: none;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        .shiva-hero .memorial-link:hover { opacity: 0.7; }

        .hero-divider {
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            margin: 1.5rem auto 0;
        }

        /* ── Organizer Banner ──────────────────────────── */

        .organizer-banner {
            background: #fff3e0;
            border: 2px solid #ffcc80;
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            text-align: center;
        }

        .organizer-banner p {
            font-size: 0.95rem;
            color: #e65100;
            font-weight: 500;
        }

        /* ── Info Cards ──────────────────────────────────── */

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .info-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px var(--soft-shadow);
        }

        .info-card h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-brown);
        }

        .info-card p {
            font-size: 1rem;
            color: var(--dark-brown);
            line-height: 1.6;
        }

        .donation-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.5rem;
            color: var(--terracotta);
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .donation-link:hover { opacity: 0.7; }

        /* ── Recommended Caterers ─────────────────────────── */

        .caterer-section {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid var(--light-taupe);
        }

        .caterer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .caterer-rec-card {
            background: white;
            border: 1px solid var(--light-taupe);
            border-radius: 0.8rem;
            padding: 1.1rem;
            text-decoration: none;
            color: var(--dark-brown);
            transition: transform 0.15s, box-shadow 0.15s;
            display: block;
        }

        .caterer-rec-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--soft-shadow);
        }

        .caterer-rec-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .caterer-rec-detail {
            font-size: 0.82rem;
            color: var(--sage-dark);
            line-height: 1.4;
        }

        .caterer-fallback {
            text-align: center;
            margin-top: 1rem;
        }

        .caterer-fallback a {
            color: var(--terracotta);
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
        }

        .caterer-fallback a:hover { opacity: 0.7; }

        /* ── Meal Calendar ────────────────────────────────── */

        .calendar-section {
            margin: 2.5rem 0;
        }

        .section-heading {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            font-weight: 500;
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--dark-brown);
        }

        .section-heading::after {
            content: '';
            display: block;
            width: 50px;
            height: 2px;
            background: var(--gold);
            margin: 0.75rem auto 0;
        }

        .meal-calendar {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .meal-day-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 2px 12px var(--soft-shadow);
        }

        .meal-day-card.shabbat {
            background: #f8f5f0;
        }

        .meal-day-header {
            padding: 0.7rem 1.25rem;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--cream);
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        .meal-day-card.shabbat .meal-day-header {
            background: #f0ebe3;
        }

        .shabbat-badge {
            font-size: 0.7rem;
            color: var(--gold);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .meal-slots-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        /* ── Meal Slot Base ──────────────────────────────── */

        .meal-slot {
            padding: 0.85rem 1rem;
            min-height: 76px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            transition: background 0.15s;
        }

        .meal-slot:first-child {
            border-right: 1px solid var(--cream);
        }

        .meal-slot-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.3rem;
        }

        /* ── Available Slot (green) ──────────────────────── */

        .meal-slot.available {
            background: var(--green-light);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            border-left: 4px solid var(--green-mid);
            user-select: none;
        }

        .meal-slot.available:hover,
        .meal-slot.available:active {
            background: #dcedc8;
        }

        .meal-slot.available .meal-slot-label {
            color: var(--green-text);
        }

        .meal-slot.available .slot-action {
            color: #689f38;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .meal-slot.available .slot-action .plus {
            font-size: 1.1rem;
            margin-right: 0.2rem;
        }

        /* ── Taken Slot (grey) ──────────────────────────── */

        .meal-slot.taken {
            background: #fafafa;
            border-left: 4px solid #e0e0e0;
        }

        .meal-slot.taken .meal-slot-label {
            color: var(--sage-dark);
        }

        .meal-slot.taken .vol-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-brown);
        }

        .meal-slot.taken .vol-desc {
            font-size: 0.8rem;
            color: var(--sage-dark);
            margin-top: 0.1rem;
        }

        .remove-btn {
            font-size: 0.7rem;
            color: #c62828;
            background: transparent;
            border: 1px solid #ef9a9a;
            border-radius: 1rem;
            padding: 0.2rem 0.6rem;
            cursor: pointer;
            font-family: 'Source Serif 4', serif;
            transition: all 0.2s;
            margin-top: 0.35rem;
            display: inline-block;
        }

        .remove-btn:hover {
            background: #ffebee;
            border-color: #c62828;
        }

        /* ── Shabbat Message ─────────────────────────────── */

        .shabbat-message {
            text-align: center;
            padding: 1rem 1.25rem;
            color: var(--sage-dark);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* ── Modal (shared) ──────────────────────────────── */

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .modal .modal-subtitle {
            font-size: 0.95rem;
            color: var(--sage-dark);
            margin-bottom: 1.25rem;
        }

        /* ── Form Elements ───────────────────────────────── */

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-brown);
            margin-bottom: 0.3rem;
        }

        .form-group label .optional {
            font-weight: 400;
            color: var(--sage-dark);
            font-size: 0.8rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.7rem 0.9rem;
            font-family: 'Source Serif 4', serif;
            font-size: 1rem;
            border: 2px solid var(--light-taupe);
            border-radius: 0.5rem;
            background: white;
            color: var(--dark-brown);
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--terracotta);
        }

        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--sage);
        }

        /* ── Food Chips ──────────────────────────────────── */

        .food-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .food-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.9rem;
            border: 2px solid var(--light-taupe);
            border-radius: 2rem;
            font-family: 'Source Serif 4', serif;
            font-size: 0.9rem;
            background: white;
            color: var(--dark-brown);
            cursor: pointer;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .food-chip:hover {
            border-color: var(--terracotta);
        }

        .food-chip.selected {
            background: var(--terracotta);
            color: white;
            border-color: var(--terracotta);
        }

        /* ── Servings Counter ────────────────────────────── */

        .servings-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .servings-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--light-taupe);
            background: white;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-family: 'Source Serif 4', serif;
            color: var(--dark-brown);
            -webkit-tap-highlight-color: transparent;
        }

        .servings-btn:hover {
            border-color: var(--terracotta);
            color: var(--terracotta);
        }

        .servings-btn:active {
            background: var(--cream);
        }

        .servings-value {
            font-size: 1.05rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        /* ── Consent ─────────────────────────────────────── */

        .consent-row {
            display: flex;
            gap: 0.6rem;
            align-items: flex-start;
            margin: 1rem 0;
            padding: 0.75rem;
            background: var(--cream);
            border-radius: 0.5rem;
            border: 1px solid var(--light-taupe);
        }

        .consent-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 0.1rem;
            accent-color: var(--terracotta);
        }

        .consent-row label {
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--dark-brown);
        }

        .consent-row label a { color: var(--terracotta); }

        /* ── Buttons ─────────────────────────────────────── */

        .modal-btn-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .btn-primary {
            flex: 1;
            background: var(--terracotta);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 2rem;
            font-family: 'Source Serif 4', serif;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #c45a1a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--warm-glow);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--dark-brown);
            border: 2px solid var(--light-taupe);
            padding: 0.8rem 1.5rem;
            border-radius: 2rem;
            font-family: 'Source Serif 4', serif;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover { border-color: var(--dark-brown); }

        .form-error {
            display: none;
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
            border-radius: 0.5rem;
            padding: 0.6rem 0.9rem;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }

        .form-error.active { display: block; }

        /* ── Signup Confirmation ──────────────────────────── */

        .signup-confirmation {
            text-align: center;
        }

        .signup-confirmation h2 {
            margin-bottom: 0.25rem;
        }

        .confirm-icon {
            width: 56px;
            height: 56px;
            background: var(--green-light);
            border: 3px solid var(--green-mid);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            margin: 0 auto 0.75rem;
            color: var(--green-text);
        }

        .confirm-address {
            background: var(--green-light);
            border: 2px solid var(--green-mid);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin: 1rem 0;
            text-align: left;
        }

        .confirm-address .addr-label {
            font-size: 0.75rem;
            color: var(--green-text);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.25rem;
        }

        .confirm-address .addr-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-brown);
        }

        .confirm-address .addr-instructions {
            font-size: 0.9rem;
            color: var(--sage-dark);
            font-style: italic;
            margin-top: 0.4rem;
        }

        .calendar-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: white;
            border: 2px solid var(--light-taupe);
            padding: 0.6rem 1.25rem;
            border-radius: 2rem;
            color: var(--dark-brown);
            text-decoration: none;
            font-family: 'Source Serif 4', serif;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        .calendar-link:hover {
            border-color: var(--terracotta);
            color: var(--terracotta);
        }

        /* ── Address Reveal (persistent) ─────────────────── */

        .address-reveal {
            display: none;
        }

        .address-reveal.active {
            display: block;
        }

        .address-card {
            background: var(--green-light);
            border: 2px solid var(--green-mid);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            margin: 1.5rem 0;
        }

        .address-card h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--green-text);
            margin-bottom: 0.4rem;
        }

        .address-card .address-text {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--dark-brown);
            margin-bottom: 0.35rem;
        }

        .address-card .instructions-text {
            font-size: 0.9rem;
            color: var(--sage-dark);
            font-style: italic;
        }

        /* ── Archived State ──────────────────────────────── */

        .archived-notice {
            text-align: center;
            padding: 2rem;
            background: var(--cream);
            border-radius: 1rem;
            margin: 2rem 0;
        }

        .archived-notice p {
            color: var(--sage-dark);
            font-size: 1.1rem;
        }

        /* ── Report Link ─────────────────────────────────── */

        .report-link {
            display: inline-block;
            color: var(--sage-dark);
            font-size: 0.85rem;
            text-decoration: none;
            cursor: pointer;
            margin-top: 0.75rem;
            transition: color 0.2s;
        }

        .report-link:hover { color: var(--terracotta); }

        /* ── Footer ──────────────────────────────────────── */

        .site-footer {
            max-width: 800px;
            margin: 3rem auto 0;
            padding: 2rem 1.5rem;
            border-top: 1px solid var(--light-taupe);
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1.25rem;
        }

        .footer-links a { color: var(--dark-brown); text-decoration: none; font-size: 1rem; transition: color 0.2s; }
        .footer-links a:hover { color: var(--terracotta); }
        .footer-copy { font-size: 0.85rem; color: var(--sage-dark); }

        /* ── Responsive ──────────────────────────────────── */

        @media (max-width: 600px) {
            .nav { gap: 1rem; padding: 1rem; }
            .nav-links { gap: 1rem; }
            .page-container { padding: 0 1rem 3rem; }
            .info-cards { grid-template-columns: 1fr; }

            .modal-overlay {
                align-items: flex-end;
                padding: 0;
            }
            .modal {
                border-radius: 1.25rem 1.25rem 0 0;
                max-height: 92vh;
                padding: 1.5rem;
            }
            .modal::before {
                content: '';
                display: block;
                width: 36px;
                height: 4px;
                background: var(--light-taupe);
                border-radius: 2px;
                margin: 0 auto 1rem;
            }
            .modal-btn-row { flex-direction: column; }

            .meal-slots-grid { grid-template-columns: 1fr 1fr; }
            .meal-slot { padding: 0.75rem 0.7rem; min-height: 70px; }
            .meal-slot-label { font-size: 0.65rem; }

            .food-chip {
                padding: 0.45rem 0.75rem;
                font-size: 0.85rem;
            }

            .footer-links { gap: 1.25rem; }
        }

        @media (max-width: 360px) {
            .meal-slot { padding: 0.6rem 0.5rem; min-height: 64px; }
            .meal-slot.available .slot-action { font-size: 0.8rem; }
        }
    </style>
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Neshama — Every Soul Remembered">
    <meta name="twitter:description" content="Obituaries and memorials from Toronto and Montreal's Jewish funeral homes, in one place.">
    <meta name="twitter:image" content="https://neshama.ca/og-image.png">
    <script defer data-domain="neshama.ca" src="https://plausible.io/js/script.js"></script>
</head>
<body>

    <!-- Navigation -->
    <nav class="nav">
        <a href="/" class="nav-brand">Neshama</a>
        <div class="nav-links">
            <a href="/feed">Feed</a>
            <a href="/shiva-essentials">Essentials</a>
            <a href="/gifts">Gifts</a>
            <a href="/about">About</a>
            <a href="/shiva/organize" style="background:#C75B12;color:white;padding:0.45rem 1.1rem;border-radius:8px;font-weight:600;font-size:0.88rem;">Organize Shiva</a>
        </div>
    </nav>

    <!-- Loading State -->
    <div class="page-container" id="pageLoading">
        <div class="page-loading">
            <div class="loading-spinner"></div>
            <p>Loading support page...</p>
        </div>
    </div>

    <!-- Error State -->
    <div class="page-container" id="errorState" style="display: none;">
        <div class="error-state">
            <h2>Support Page Not Found</h2>
            <p>This support page may have been archived or the link may be incorrect.</p>
            <a href="/feed">Return to Feed</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="page-container" id="mainContent" style="display: none;">

        <!-- Hero -->
        <section class="shiva-hero">
            <h1 id="familyName"></h1>
            <p class="organized-by" id="organizedBy" style="display: none;"></p>
            <p class="dates" id="shivaDates"></p>
            <a class="memorial-link" id="memorialLink" href="#" style="display: none;">View Memorial &#x2197;</a>
            <div class="hero-divider"></div>
        </section>

        <div style="background: var(--cream); border-left: 3px solid var(--sage); padding: 0.65rem 0.9rem; border-radius: 0.4rem; margin: 1rem 0; font-size: 0.88rem; color: var(--sage-dark); line-height: 1.5; text-align: center;">
            Preparing for shiva? See our <a href="/shiva-essentials" style="color: var(--terracotta); text-decoration: none; font-weight: 500;">Shiva Essentials guide</a> for memorial candles, prayer books, and everything the community needs. &rarr;
        </div>

        <!-- Private Page Notice (shown when page is private and visitor has no access) -->
        <div id="privateNotice" style="display: none;">
            <div style="background: var(--cream); border-radius: 1rem; padding: 2rem; text-align: center; margin: 1.5rem 0; border: 1px solid var(--light-taupe);">
                <p style="font-size: 1.1rem; line-height: 1.6; color: var(--dark-brown); margin-bottom: 1rem;">This shiva page is private. The family has chosen to coordinate meals through direct invitations.</p>
                <p style="font-size: 0.95rem; color: var(--sage-dark); margin-bottom: 1.5rem;">If you know the family, you can request access below.</p>
                <button onclick="showAccessForm()" style="background: var(--terracotta); color: white; border: none; padding: 0.85rem 2rem; border-radius: 2rem; font-family: 'Source Serif 4', serif; font-size: 1.05rem; cursor: pointer;">Request Access</button>
            </div>
            <div id="accessForm" style="display: none; background: white; border-radius: 1rem; padding: 2rem; margin-top: 1rem; box-shadow: 0 4px 20px rgba(62,39,35,0.08);">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; margin-bottom: 1rem; color: var(--dark-brown);">Request Access</h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.95rem;">Your Name</label>
                    <input type="text" id="accessName" placeholder="Your full name" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-taupe); border-radius: 0.5rem; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.95rem;">Your Email</label>
                    <input type="email" id="accessEmail" placeholder="your@email.com" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-taupe); border-radius: 0.5rem; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.95rem;">How do you know the family? <span style="color: var(--sage-dark); font-weight: 400;">(optional)</span></label>
                    <textarea id="accessMessage" placeholder="e.g., Neighbour, colleague, friend from shul..." rows="2" style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-taupe); border-radius: 0.5rem; font-family: inherit; font-size: 1rem; box-sizing: border-box; resize: vertical;"></textarea>
                </div>
                <div id="accessError" style="display: none; color: #c0392b; font-size: 0.9rem; margin-bottom: 1rem;"></div>
                <button id="accessSubmitBtn" onclick="submitAccessRequest()" style="background: var(--terracotta); color: white; border: none; padding: 0.85rem 2rem; border-radius: 2rem; font-family: 'Source Serif 4', serif; font-size: 1.05rem; cursor: pointer; width: 100%;">Send Request</button>
            </div>
            <div id="accessSuccess" style="display: none; background: var(--cream); border-radius: 1rem; padding: 2rem; text-align: center; margin-top: 1rem;">
                <p style="font-size: 1.1rem; color: var(--dark-brown); line-height: 1.6;">Your request has been sent. You'll receive an email when the organizer responds.</p>
            </div>
        </div>

        <!-- Organizer Banner -->
        <div class="organizer-banner" id="organizerBanner" style="display: none;">
            <p>Organizer view &mdash; you can manage signups below</p>
        </div>

        <!-- Info Cards -->
        <div class="info-cards" id="infoCards"></div>

        <!-- Address Reveal (shown to organizer or after signup) -->
        <div class="address-reveal" id="addressReveal">
            <div class="address-card">
                <h3>Shiva Location</h3>
                <p class="address-text" id="revealedAddress"></p>
                <p class="instructions-text" id="revealedInstructions"></p>
            </div>
        </div>

        <!-- Meal Calendar -->
        <section class="calendar-section" id="calendarSection">
            <h2 class="section-heading">Meal Schedule</h2>
            <div class="meal-calendar" id="mealCalendar"></div>
        </section>

        <!-- Recommended Caterers -->
        <section id="catererSection" style="display:none;"></section>

        <!-- Send Something Thoughtful -->
        <section id="giftSection" style="margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid var(--light-taupe);">
            <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; font-weight: 500; color: var(--terracotta); text-align: center; margin-bottom: 0.4rem;">Send Something Thoughtful</h2>
            <p style="text-align: center; color: var(--sage-dark); font-size: 1rem; margin-bottom: 1.5rem;">Can't be there in person? Send comfort to the family.</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.8rem;">
                <a href="/gifts?category=shiva-platters" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#127869;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Shiva Platters</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">Ready-to-serve meals</div>
                </a>
                <a href="/gifts?category=baked-goods" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#129360;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Baked Goods</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">Pastries, cakes &amp; rugelach</div>
                </a>
                <a href="/gifts?category=chocolate" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#127851;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Chocolate &amp; Sweets</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">Sweet treats &amp; candy</div>
                </a>
                <a href="/gifts?category=fruit-nuts" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#127822;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Fruit &amp; Nuts</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">Baskets &amp; dried fruit trays</div>
                </a>
                <a href="/gifts?category=gift-baskets" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#127873;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Gift Baskets</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">Curated comfort packages</div>
                </a>
                <a href="/gifts?category=kosher" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#10017;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Kosher Certified</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">COR &amp; certified options</div>
                </a>
                <a href="/gifts/plant-a-tree" style="background: var(--cream); border: 1px solid var(--light-taupe); border-radius: 0.8rem; padding: 1.1rem 0.8rem; text-align: center; text-decoration: none; color: var(--dark-brown); transition: transform 0.15s, box-shadow 0.15s;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">&#127795;</div>
                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem;">Plant a Tree</div>
                    <div style="font-size: 0.8rem; color: var(--sage-dark);">A living memorial in Israel</div>
                </a>
            </div>
        </section>
    </div>

    <!-- Signup Modal -->
    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <!-- Form View -->
            <div id="signupFormView">
                <h2>Sign Up to Help</h2>
                <p class="modal-subtitle" id="modalSubtitle"></p>

                <div class="form-group">
                    <label for="volName">Your Name</label>
                    <input type="text" id="volName" placeholder="Your full name" autocomplete="name">
                </div>

                <div class="form-group">
                    <label>What are you bringing?</label>
                    <div class="food-chips" id="foodChips">
                        <button type="button" class="food-chip" data-food="Main dish">Main dish</button>
                        <button type="button" class="food-chip" data-food="Soup">Soup</button>
                        <button type="button" class="food-chip" data-food="Salad">Salad</button>
                        <button type="button" class="food-chip" data-food="Side dish">Side dish</button>
                        <button type="button" class="food-chip" data-food="Dessert">Dessert</button>
                        <button type="button" class="food-chip" data-food="Full meal">Full meal</button>
                    </div>
                    <input type="text" id="mealCustom" placeholder="Or describe what you're bringing..." style="margin-top: 0.5rem;">
                </div>

                <div style="background: var(--cream); border-left: 3px solid var(--sage); padding: 0.65rem 0.9rem; border-radius: 0.4rem; margin-bottom: 1rem; font-size: 0.88rem; color: var(--sage-dark); line-height: 1.5;">
                    Need ideas? <a href="/shiva/caterers" target="_blank" rel="noopener noreferrer" style="color: var(--terracotta); text-decoration: none; font-weight: 500;">Browse local kosher caterers</a> or explore our <a href="/directory" style="color: var(--terracotta); text-decoration: none; font-weight: 500;">food vendor directory</a> for shiva meals.
                </div>

                <div class="form-group">
                    <label>Servings</label>
                    <div class="servings-row">
                        <button type="button" class="servings-btn" id="servMinus">&minus;</button>
                        <span class="servings-value" id="servingsValue">4 servings</span>
                        <button type="button" class="servings-btn" id="servPlus">+</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="volEmail">Your Email</label>
                    <input type="email" id="volEmail" placeholder="you@example.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="volPhone">Phone <span class="optional">(optional)</span></label>
                    <input type="tel" id="volPhone" placeholder="(416) 555-0123" autocomplete="tel">
                </div>

                <div class="consent-row">
                    <input type="checkbox" id="volConsent">
                    <label for="volConsent">
                        I consent to sharing my details with the family.
                        <a href="/privacy" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <div class="form-error" id="signupError"></div>

                <div class="modal-btn-row">
                    <button class="btn-secondary" id="signupCancelBtn">Cancel</button>
                    <button class="btn-primary" id="signupSubmitBtn">Sign Up</button>
                </div>
            </div>

            <!-- Confirmation View -->
            <div id="signupConfirmView" style="display: none;">
                <div class="signup-confirmation">
                    <div class="confirm-icon">&#x2713;</div>
                    <h2>Thank You!</h2>
                    <p class="modal-subtitle" id="confirmSubtitle"></p>

                    <div class="confirm-address" id="confirmAddress">
                        <div class="addr-label">Shiva Location</div>
                        <div class="addr-text" id="confirmAddrText"></div>
                        <div class="addr-instructions" id="confirmInstructions"></div>
                    </div>

                    <a class="calendar-link" id="googleCalLink" href="#" target="_blank" rel="noopener noreferrer">
                        &#x1F4C5; Add to Google Calendar
                    </a>

                    <p style="text-align:center;margin-top:1.25rem;font-size:0.95rem;color:var(--sage-dark);font-style:italic;">
                        May their memory be a blessing
                    </p>

                    <p style="text-align:center;margin-top:0.75rem;font-size:0.95rem;color:var(--sage-dark);">
                        Need help with your meal? <a href="/shiva/caterers">Browse local caterers</a>
                    </p>

                    <div class="modal-btn-row" style="justify-content: center; margin-top: 1.25rem;">
                        <button class="btn-primary" id="confirmDoneBtn">Done</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <h2>Report This Page</h2>
            <p class="modal-subtitle">If you believe this page was created without authorization, please let us know.</p>

            <div class="form-group">
                <label for="reportName">Your Name</label>
                <input type="text" id="reportName" placeholder="Your full name">
            </div>

            <div class="form-group">
                <label for="reportEmail">Your Email</label>
                <input type="email" id="reportEmail" placeholder="you@example.com">
            </div>

            <div class="form-group">
                <label for="reportReason">Reason for Report</label>
                <textarea id="reportReason" placeholder="Please explain why you believe this page should be reviewed..."></textarea>
            </div>

            <div class="form-error" id="reportError"></div>

            <div class="modal-btn-row">
                <button class="btn-secondary" id="reportCancelBtn">Cancel</button>
                <button class="btn-primary" id="reportSubmitBtn">Submit Report</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <nav class="footer-links">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/faq">FAQ</a>
            <a href="/shiva-essentials">Shiva Essentials</a>
            <a href="/what-to-bring-to-a-shiva">What to Bring</a>
            <a href="/gifts">Send a Gift</a>
            <a href="/directory">Directory</a>
            <a href="/privacy">Privacy</a>
            <a href="mailto:contact@neshama.ca">Contact</a>
        </nav>
        <p class="footer-copy">Built with care for the Jewish community</p>
        <a class="report-link" id="reportPageLink">Report this page</a>
    </footer>

    <script>
    (function() {
        'use strict';

        var supportId = null;
        var supportData = null;
        var mealsData = [];
        var selectedDate = null;
        var selectedMealType = null;
        var currentServings = 4;
        var isOrganizerMode = false;
        var organizerToken = null;
        var accessToken = null;
        var isPrivateLimited = false;
        var lastSignupAddress = null;

        // ── URL Parsing ─────────────────────────────────

        function getSupportIdFromUrl() {
            var path = window.location.pathname;
            var parts = path.split('/');
            if (parts.length >= 3 && parts[1] === 'shiva') {
                return decodeURIComponent(parts.slice(2).join('/'));
            }
            return null;
        }

        function getTokenFromUrl() {
            var params = new URLSearchParams(window.location.search);
            return params.get('token') || null;
        }

        // ── Utilities ─────────────────────────────────

        function escapeHtml(str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                var d = new Date(dateStr + 'T12:00:00');
                return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            } catch (e) { return dateStr; }
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                var d = new Date(dateStr + 'T12:00:00');
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            } catch (e) { return dateStr; }
        }

        function formatDateRange(start, end) {
            try {
                var s = new Date(start + 'T12:00:00');
                var e = new Date(end + 'T12:00:00');
                var opts = { month: 'long', day: 'numeric' };
                return s.toLocaleDateString('en-US', opts) + ' \u2013 ' +
                    e.toLocaleDateString('en-US', Object.assign({}, opts, { year: 'numeric' }));
            } catch (err) { return start + ' - ' + end; }
        }

        function show(id) { var el = document.getElementById(id); if (el) el.style.display = ''; }
        function hide(id) { var el = document.getElementById(id); if (el) el.style.display = 'none'; }

        // ── Load Support Data ───────────────────────────

        function loadSupportPage() {
            supportId = getSupportIdFromUrl();
            organizerToken = getTokenFromUrl();
            isOrganizerMode = !!organizerToken;

            // Check for access token (for private pages)
            var params = new URLSearchParams(window.location.search);
            accessToken = params.get('access') || null;

            if (!supportId) {
                hide('pageLoading');
                show('errorState');
                return;
            }

            var shivaUrl = '/api/shiva/' + encodeURIComponent(supportId);
            var mealsUrl = '/api/shiva/' + encodeURIComponent(supportId) + '/meals';
            if (organizerToken) {
                shivaUrl += '?token=' + encodeURIComponent(organizerToken);
                mealsUrl += '?token=' + encodeURIComponent(organizerToken);
            } else if (accessToken) {
                shivaUrl += '?access=' + encodeURIComponent(accessToken);
            }

            Promise.all([
                fetch(shivaUrl).then(function(r) { return r.json(); }),
                fetch(mealsUrl).then(function(r) { return r.json(); })
            ])
            .then(function(results) {
                var shivaResult = results[0];
                var mealsResult = results[1];

                if (!shivaResult || shivaResult.status !== 'success' || !shivaResult.data) {
                    throw new Error('Not found');
                }

                supportData = shivaResult.data;
                mealsData = (mealsResult && mealsResult.data) || [];
                isPrivateLimited = (shivaResult.access === 'limited');

                if (supportData.status === 'archived') {
                    renderArchived();
                    return;
                }

                if (isPrivateLimited) {
                    renderPrivateLimited();
                    return;
                }

                renderPage();
            })
            .catch(function() {
                hide('pageLoading');
                show('errorState');
            });
        }

        // ── Render Archived ─────────────────────────────

        function renderArchived() {
            hide('pageLoading');
            document.getElementById('familyName').textContent = supportData.family_name || 'Support Page';
            var main = document.getElementById('mainContent');
            main.innerHTML = '<section class="shiva-hero"><h1>' + escapeHtml(supportData.family_name) +
                '</h1><div class="hero-divider"></div></section>' +
                '<div class="archived-notice"><p>This shiva support page has been archived. ' +
                'Thank you to everyone who helped coordinate meals.</p></div>';
            show('mainContent');
        }

        // ── Render Private Limited View ─────────────────

        function renderPrivateLimited() {
            document.title = supportData.family_name + ' - Shiva Support - Neshama';
            document.getElementById('familyName').textContent = supportData.family_name;

            if (supportData.shiva_start_date && supportData.shiva_end_date) {
                document.getElementById('shivaDates').textContent =
                    formatDateRange(supportData.shiva_start_date, supportData.shiva_end_date);
            }

            if (supportData.obituary_id && supportData.obituary_id !== 'unknown') {
                var ml = document.getElementById('memorialLink');
                ml.href = '/memorial/' + encodeURIComponent(supportData.obituary_id);
                ml.style.display = '';
            }

            // Hide sections that require access
            hide('infoCards');
            hide('addressReveal');
            var calSec = document.getElementById('calendarSection');
            if (calSec) calSec.style.display = 'none';

            // Show private notice
            show('privateNotice');

            hide('pageLoading');
            show('mainContent');
        }

        function showAccessForm() {
            show('accessForm');
        }

        function submitAccessRequest() {
            var name = document.getElementById('accessName').value.trim();
            var email = document.getElementById('accessEmail').value.trim();
            var message = document.getElementById('accessMessage').value.trim();
            var errEl = document.getElementById('accessError');
            var btn = document.getElementById('accessSubmitBtn');

            errEl.style.display = 'none';

            if (!name || !email) {
                errEl.textContent = 'Please enter your name and email.';
                errEl.style.display = '';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Sending...';

            fetch('/api/shiva-access/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    shiva_id: supportId,
                    requester_name: name,
                    requester_email: email,
                    message: message
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.status === 'success') {
                    hide('accessForm');
                    show('accessSuccess');
                } else if (result.status === 'already_approved' && result.access_token) {
                    // Already approved — reload with token
                    window.location.href = '/shiva/' + encodeURIComponent(supportId) + '?access=' + encodeURIComponent(result.access_token);
                } else {
                    errEl.textContent = result.message || 'Something went wrong.';
                    errEl.style.display = '';
                    btn.disabled = false;
                    btn.textContent = 'Send Request';
                }
            })
            .catch(function() {
                errEl.textContent = 'Network error. Please try again.';
                errEl.style.display = '';
                btn.disabled = false;
                btn.textContent = 'Send Request';
            });
        }

        // ── Render Main Page ────────────────────────────

        function renderPage() {
            document.title = supportData.family_name + ' - Shiva Support - Neshama';
            document.getElementById('familyName').textContent = supportData.family_name;

            // Organized by
            if (supportData.organizer_name) {
                var obEl = document.getElementById('organizedBy');
                obEl.textContent = 'Organized by ' + supportData.organizer_name +
                    (supportData.organizer_relationship ? ' (' + supportData.organizer_relationship + ')' : '');
                obEl.style.display = '';
            }

            // Dates
            if (supportData.shiva_start_date && supportData.shiva_end_date) {
                document.getElementById('shivaDates').textContent =
                    formatDateRange(supportData.shiva_start_date, supportData.shiva_end_date);
            }

            // Memorial link
            if (supportData.obituary_id && supportData.obituary_id !== 'unknown') {
                var ml = document.getElementById('memorialLink');
                ml.href = '/memorial/' + encodeURIComponent(supportData.obituary_id);
                ml.style.display = '';
            }

            // Organizer mode
            if (isOrganizerMode) {
                show('organizerBanner');
            }

            // Address for organizer
            if (isOrganizerMode && supportData.shiva_address) {
                var addrText = supportData.shiva_address;
                if (supportData.shiva_city) addrText += ', ' + supportData.shiva_city;
                document.getElementById('revealedAddress').textContent = addrText;
                document.getElementById('revealedInstructions').textContent = supportData.special_instructions || '';
                document.getElementById('addressReveal').classList.add('active');
            }

            renderInfoCards();
            renderMealCalendar();
            renderRecommendedCaterers();

            hide('pageLoading');
            show('mainContent');
        }

        // ── Render Info Cards ───────────────────────────

        function renderInfoCards() {
            var html = '';
            if (supportData.guests_per_meal) {
                html += '<div class="info-card"><h3>Guests per Meal</h3><p>' +
                    escapeHtml(String(supportData.guests_per_meal)) +
                    ' people expected</p></div>';
            }
            if (supportData.dietary_notes) {
                html += '<div class="info-card"><h3>Dietary Notes</h3><p>' +
                    escapeHtml(supportData.dietary_notes) + '</p></div>';
            }
            if (supportData.donation_url) {
                html += '<div class="info-card"><h3>' +
                    escapeHtml(supportData.donation_label || 'Donate') + '</h3>' +
                    '<a class="donation-link" href="' + escapeHtml(supportData.donation_url) +
                    '" target="_blank" rel="noopener noreferrer">Make a Donation &#x2197;</a></div>';
            }
            document.getElementById('infoCards').innerHTML = html;
        }

        // ── Render Recommended Caterers ─────────────────

        function renderRecommendedCaterers() {
            var section = document.getElementById('catererSection');
            var raw = supportData.recommended_vendors;
            var slugs = [];

            if (raw) {
                try { slugs = JSON.parse(raw); } catch(e) {}
            }

            if (!slugs || !slugs.length) {
                // Show generic fallback
                section.className = 'caterer-section';
                section.innerHTML =
                    '<h2 class="section-heading">Need Meal Ideas?</h2>' +
                    '<div class="caterer-fallback">' +
                    '<a href="/directory">Browse kosher caterers in your area &#8594;</a>' +
                    '</div>';
                section.style.display = '';
                return;
            }

            // Fetch vendors and filter to recommended slugs
            fetch('/api/vendors')
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (!result || result.status !== 'success' || !result.data) return;

                var slugSet = {};
                slugs.forEach(function(s) { slugSet[s] = true; });

                var matched = result.data.filter(function(v) { return slugSet[v.slug]; });
                if (!matched.length) return;

                var html = '<h2 class="section-heading">Family\'s Recommended Caterers</h2>';
                html += '<p style="text-align:center;color:var(--sage-dark);font-size:0.95rem;margin-top:-0.75rem;">The family recommends these local caterers for shiva meals</p>';
                html += '<div class="caterer-grid">';

                matched.forEach(function(v) {
                    var dest = v.website || ('/directory/' + encodeURIComponent(v.slug));
                    var trackUrl = '/api/track-click?vendor=' + encodeURIComponent(v.slug) +
                        '&dest=' + encodeURIComponent(dest);

                    html += '<a class="caterer-rec-card" href="' + escapeHtml(trackUrl) +
                        '" target="_blank" rel="noopener noreferrer">';
                    html += '<div class="caterer-rec-name">' + escapeHtml(v.name) + '</div>';
                    if (v.neighborhood) {
                        html += '<div class="caterer-rec-detail">' + escapeHtml(v.neighborhood) + '</div>';
                    }
                    if (v.kosher_status) {
                        html += '<div class="caterer-rec-detail">' + escapeHtml(v.kosher_status) + '</div>';
                    }
                    if (v.phone) {
                        html += '<div class="caterer-rec-detail">' + escapeHtml(v.phone) + '</div>';
                    }
                    html += '</a>';
                });

                html += '</div>';
                html += '<div class="caterer-fallback"><a href="/directory">Browse all caterers &#8594;</a></div>';

                section.className = 'caterer-section';
                section.innerHTML = html;
                section.style.display = '';
            })
            .catch(function() {
                // Silently fail - not critical
            });
        }

        // ── Render Meal Calendar ────────────────────────

        function renderMealCalendar() {
            if (!supportData.shiva_start_date || !supportData.shiva_end_date) return;

            var start = new Date(supportData.shiva_start_date + 'T12:00:00');
            var end = new Date(supportData.shiva_end_date + 'T12:00:00');

            // Build signup lookup
            var signupMap = {};
            mealsData.forEach(function(m) {
                signupMap[m.meal_date + '_' + m.meal_type] = m;
            });

            var html = '';
            var current = new Date(start);

            while (current <= end) {
                var dateStr = current.toISOString().split('T')[0];
                var dayOfWeek = current.getDay();
                var isShabbat = dayOfWeek === 5 || dayOfWeek === 6;
                var isPaused = isShabbat && supportData.pause_shabbat;

                html += '<div class="meal-day-card' + (isPaused ? ' shabbat' : '') + '">';
                html += '<div class="meal-day-header"><span>' + formatDateShort(dateStr) + '</span>';
                if (isPaused) html += '<span class="shabbat-badge">Shabbat</span>';
                html += '</div>';

                if (!isPaused) {
                    html += '<div class="meal-slots-grid">';
                    html += renderSlot(dateStr, 'Lunch', signupMap[dateStr + '_Lunch']);
                    html += renderSlot(dateStr, 'Dinner', signupMap[dateStr + '_Dinner']);
                    html += '</div>';
                } else {
                    html += '<div class="shabbat-message">Paused for Shabbat</div>';
                }

                html += '</div>';
                current.setDate(current.getDate() + 1);
            }

            document.getElementById('mealCalendar').innerHTML = html;
        }

        function renderSlot(dateStr, mealType, signup) {
            if (signup) {
                var h = '<div class="meal-slot taken">';
                h += '<div class="meal-slot-label">' + mealType + '</div>';
                h += '<div class="vol-name">' + escapeHtml(signup.volunteer_name) + '</div>';
                if (signup.meal_description) {
                    h += '<div class="vol-desc">' + escapeHtml(signup.meal_description) + '</div>';
                }
                if (isOrganizerMode && signup.id) {
                    h += '<button class="remove-btn" data-signup-id="' + signup.id + '">Remove</button>';
                }
                h += '</div>';
                return h;
            }
            return '<div class="meal-slot available" data-date="' + dateStr + '" data-meal="' + mealType + '" role="button" tabindex="0" aria-label="Sign up for ' + mealType + ' on ' + formatDateShort(dateStr) + '">' +
                '<div class="meal-slot-label">' + mealType + '</div>' +
                '<div class="slot-action"><span class="plus">+</span> Available</div>' +
                '</div>';
        }

        // ── Event Delegation for Calendar ───────────────

        document.addEventListener('click', function(e) {
            // Available slot click
            var slot = e.target.closest('.meal-slot.available');
            if (slot) {
                openSignup(slot.getAttribute('data-date'), slot.getAttribute('data-meal'));
                return;
            }
            // Remove button click
            var rmBtn = e.target.closest('.remove-btn');
            if (rmBtn) {
                removeSignup(rmBtn.getAttribute('data-signup-id'));
                return;
            }
        });

        // Keyboard support for slots
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                var slot = e.target.closest('.meal-slot.available');
                if (slot) {
                    e.preventDefault();
                    openSignup(slot.getAttribute('data-date'), slot.getAttribute('data-meal'));
                }
            }
        });

        // ── Open Signup ─────────────────────────────────

        function openSignup(date, mealType) {
            selectedDate = date;
            selectedMealType = mealType;
            currentServings = 4;

            document.getElementById('modalSubtitle').textContent =
                mealType + ' \u00b7 ' + formatDate(date);

            // Reset form
            document.getElementById('volName').value = '';
            document.getElementById('volEmail').value = '';
            document.getElementById('volPhone').value = '';
            document.getElementById('mealCustom').value = '';
            document.getElementById('servingsValue').textContent = '4 servings';
            document.getElementById('volConsent').checked = false;
            document.getElementById('signupError').classList.remove('active');
            document.getElementById('signupSubmitBtn').disabled = false;
            document.getElementById('signupSubmitBtn').textContent = 'Sign Up';

            // Reset chips
            var chips = document.querySelectorAll('.food-chip');
            for (var i = 0; i < chips.length; i++) chips[i].classList.remove('selected');

            show('signupFormView');
            hide('signupConfirmView');

            document.getElementById('signupModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            setTimeout(function() { document.getElementById('volName').focus(); }, 150);
        }

        function closeSignup() {
            document.getElementById('signupModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function closeSignupAndReveal() {
            closeSignup();
            if (lastSignupAddress) {
                document.getElementById('addressReveal').classList.add('active');
                setTimeout(function() {
                    document.getElementById('addressReveal').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        // ── Food Chips ──────────────────────────────────

        document.getElementById('foodChips').addEventListener('click', function(e) {
            var chip = e.target.closest('.food-chip');
            if (!chip) return;
            chip.classList.toggle('selected');
        });

        function getSelectedFoods() {
            var custom = document.getElementById('mealCustom').value.trim();
            if (custom) return custom;
            var chips = document.querySelectorAll('.food-chip.selected');
            var foods = [];
            for (var i = 0; i < chips.length; i++) {
                foods.push(chips[i].getAttribute('data-food'));
            }
            return foods.join(', ');
        }

        // ── Servings Counter ────────────────────────────

        document.getElementById('servMinus').addEventListener('click', function() {
            currentServings = Math.max(1, currentServings - 1);
            document.getElementById('servingsValue').textContent =
                currentServings + ' serving' + (currentServings !== 1 ? 's' : '');
        });

        document.getElementById('servPlus').addEventListener('click', function() {
            currentServings = Math.min(20, currentServings + 1);
            document.getElementById('servingsValue').textContent =
                currentServings + ' serving' + (currentServings !== 1 ? 's' : '');
        });

        // ── Submit Signup ───────────────────────────────

        document.getElementById('signupSubmitBtn').addEventListener('click', function() {
            var name = document.getElementById('volName').value.trim();
            var email = document.getElementById('volEmail').value.trim();
            var consent = document.getElementById('volConsent').checked;
            var errEl = document.getElementById('signupError');
            var btn = document.getElementById('signupSubmitBtn');

            if (!name || !email) {
                errEl.textContent = 'Please fill in your name and email.';
                errEl.classList.add('active');
                return;
            }
            if (email.indexOf('@') === -1 || email.indexOf('.') === -1) {
                errEl.textContent = 'Please enter a valid email address.';
                errEl.classList.add('active');
                return;
            }
            if (!consent) {
                errEl.textContent = 'Please accept the privacy consent to continue.';
                errEl.classList.add('active');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Signing up...';
            errEl.classList.remove('active');

            var mealDescription = getSelectedFoods();

            var payload = {
                volunteer_name: name,
                volunteer_email: email,
                volunteer_phone: document.getElementById('volPhone').value.trim(),
                meal_date: selectedDate,
                meal_type: selectedMealType,
                meal_description: mealDescription,
                num_servings: currentServings,
                privacy_consent: true
            };

            fetch('/api/shiva/' + encodeURIComponent(supportId) + '/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    showConfirmation(data, name, mealDescription);
                    refreshMeals();
                } else {
                    throw new Error(data.message || 'Failed to sign up');
                }
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.textContent = 'Sign Up';
                errEl.textContent = err.message || 'Something went wrong. Please try again.';
                errEl.classList.add('active');
            });
        });

        // ── Show Confirmation ───────────────────────────

        function showConfirmation(data, volunteerName, mealDescription) {
            var addrText = data.shiva_address || '';
            if (data.shiva_city) addrText += ', ' + data.shiva_city;
            lastSignupAddress = addrText;

            // Update persistent address reveal
            document.getElementById('revealedAddress').textContent = addrText;
            document.getElementById('revealedInstructions').textContent = data.special_instructions || '';

            // Populate confirmation
            document.getElementById('confirmSubtitle').textContent =
                'You\u2019re bringing ' + (mealDescription || 'a meal') + ' for ' +
                selectedMealType.toLowerCase() + ' on ' + formatDate(selectedDate);

            document.getElementById('confirmAddrText').textContent = addrText;
            document.getElementById('confirmInstructions').textContent = data.special_instructions || '';

            // Calendar link
            document.getElementById('googleCalLink').href =
                generateCalendarLink(selectedDate, selectedMealType, mealDescription, addrText);

            hide('signupFormView');
            show('signupConfirmView');
        }

        function generateCalendarLink(date, mealType, description, address) {
            var startHour = mealType === 'Lunch' ? '12' : '18';
            var endHour = mealType === 'Lunch' ? '13' : '19';
            var dateClean = date.replace(/-/g, '');
            var title = 'Bring ' + mealType.toLowerCase() + ' to ' + (supportData.family_name || 'shiva');
            var details = 'You signed up to bring: ' + (description || 'a meal') +
                '\nServings: ' + currentServings +
                '\n\nOrganized via Neshama';

            return 'https://calendar.google.com/calendar/render?action=TEMPLATE' +
                '&text=' + encodeURIComponent(title) +
                '&dates=' + dateClean + 'T' + startHour + '0000/' + dateClean + 'T' + endHour + '3000' +
                '&details=' + encodeURIComponent(details) +
                '&location=' + encodeURIComponent(address || '');
        }

        // ── Cancel / Done buttons ───────────────────────

        document.getElementById('signupCancelBtn').addEventListener('click', closeSignup);
        document.getElementById('confirmDoneBtn').addEventListener('click', closeSignupAndReveal);

        // Click outside modal to close
        document.getElementById('signupModal').addEventListener('click', function(e) {
            if (e.target === this) closeSignup();
        });

        // ── Organizer: Remove Signup ────────────────────

        function removeSignup(signupId) {
            if (!confirm('Remove this signup? The volunteer will not be notified.')) return;

            fetch('/api/shiva/' + encodeURIComponent(supportId) + '/remove-signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    signup_id: parseInt(signupId),
                    magic_token: organizerToken
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    refreshMeals();
                } else {
                    alert(data.message || 'Failed to remove signup');
                }
            })
            .catch(function() {
                alert('Something went wrong. Please try again.');
            });
        }

        // ── Refresh Meals ───────────────────────────────

        function refreshMeals() {
            var mealsUrl = '/api/shiva/' + encodeURIComponent(supportId) + '/meals';
            if (organizerToken) {
                mealsUrl += '?token=' + encodeURIComponent(organizerToken);
            }
            fetch(mealsUrl)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    mealsData = (data && data.data) || [];
                    renderMealCalendar();
                })
                .catch(function() {});
        }

        // ── Report Modal ────────────────────────────────

        function openReportModal() {
            document.getElementById('reportName').value = '';
            document.getElementById('reportEmail').value = '';
            document.getElementById('reportReason').value = '';
            document.getElementById('reportError').classList.remove('active');
            document.getElementById('reportSubmitBtn').disabled = false;
            document.getElementById('reportSubmitBtn').textContent = 'Submit Report';
            document.getElementById('reportModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('reportPageLink').addEventListener('click', openReportModal);
        document.getElementById('reportCancelBtn').addEventListener('click', closeReportModal);

        document.getElementById('reportModal').addEventListener('click', function(e) {
            if (e.target === this) closeReportModal();
        });

        document.getElementById('reportSubmitBtn').addEventListener('click', function() {
            var name = document.getElementById('reportName').value.trim();
            var email = document.getElementById('reportEmail').value.trim();
            var reason = document.getElementById('reportReason').value.trim();
            var errEl = document.getElementById('reportError');
            var btn = document.getElementById('reportSubmitBtn');

            if (!name || !email || !reason) {
                errEl.textContent = 'Please fill in all fields.';
                errEl.classList.add('active');
                return;
            }
            if (email.indexOf('@') === -1 || email.indexOf('.') === -1) {
                errEl.textContent = 'Please enter a valid email address.';
                errEl.classList.add('active');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Submitting...';
            errEl.classList.remove('active');

            fetch('/api/shiva/' + encodeURIComponent(supportId) + '/report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reporter_name: name, reporter_email: email, reason: reason })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    closeReportModal();
                    alert('Thank you. Your report has been submitted and will be reviewed.');
                } else {
                    throw new Error(data.message || 'Failed to submit report');
                }
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.textContent = 'Submit Report';
                errEl.textContent = err.message || 'Something went wrong. Please try again.';
                errEl.classList.add('active');
            });
        });

        // ── Keyboard: Escape closes modals ──────────────

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSignup();
                closeReportModal();
            }
        });

        // ── Initialize ──────────────────────────────────

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadSupportPage);
        } else {
            loadSupportPage();
        }

    })();
    </script>
    <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js');}</script>
</body>
</html>
